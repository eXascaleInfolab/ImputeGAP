=========
Tutorials
=========

.. _loading-preprocessing:

Loading and Preprocessing
-------------------------

ImputeGAP comes with several time series datasets. You can find them inside the submodule tsl.datasets.

As an example, we start by using eeg-alcohol, a standard dataset composed of individuals with a genetic predisposition to
alcoholism. The dataset contains measurements from 64 electrodes placed on subjectâ€™s scalps, sampled at 256 Hz (3.9-ms epoch) for 1 second. The dimensions of the dataset are 64 series, each containing 256 values.


**Example Loading**

.. code-block:: python

    from imputegap.recovery.manager import TimeSeries
    from imputegap.tools import utils

    # initiate the TimeSeries() object that will stay with you throughout the analysis
    ts = TimeSeries()

    # load the timeseries from file or from the code
    ts.load_series(utils.search_path("eeg-alcohol"))
    ts.normalize(normalizer="z_score")

    # [OPTIONAL] plot a subset of time series
    ts.plot(input_data=ts.data, nbr_series=6, nbr_val=100, save_path="./imputegap/assets")

    # [OPTIONAL] print a subset of time series
    ts.print(nbr_series=3,  nbr_val=100)


.. _contamination:

Contamination
-------------
We now describe how to simulate missing values in the loaded dataset. ImputeGAP implements eight different
missingness patterns.  You can find them inside the submodule tsl.patterns.

As example, we show how to contaminate the eeg-alcohol dataset with the MCAR pattern:

.. code-block:: python

    from imputegap.recovery.manager import TimeSeries
    from imputegap.tools import utils

    # initialize the TimeSeries() object
    ts = TimeSeries()

    # load and normalize the timeseries
    ts.load_series(utils.search_path("eeg-alcohol"))
    ts.normalize(normalizer="z_score")

    # contamination of the data with MCAR pattern
    ts_mask = ts.Contamination.mcar(ts.data, rate_dataset=0.1, rate_series=0.2, seed=True)

    # [OPTIONAL] plot XXXX
    ts_1.plot(ts.data, ts_mask, nbr_series=6, subplot=True, save_path="./imputegap/assets")



.. _imputation:

Imputation
----------

In this section, we will illustrate how to impute the contaminated time series. Our library implements
five families of imputation algorithms. Statistical, Machine Learning, Matrix Completion, Deep Learning, and Pattern Search Methods.
You can find the list of algorithms inside the submodule XXX.

Let's illustrate the imputation using the CDRec Algorithm from the Matrix Completion family.

.. code-block:: python

    from imputegap.recovery.imputation import Imputation
    from imputegap.recovery.manager import TimeSeries
    from imputegap.tools import utils

    # initialize the TimeSeries() object
    ts = TimeSeries()

    # load and normalize the timeseries
    ts.load_series(utils.search_path("eeg-alcohol"))
    ts.normalize(normalizer="z_score")

    # contaminate the time series
    ts_m = ts.Contamination.mcar(ts.data)

    # impute the contaminated series
    imputer = Imputation.MatrixCompletion.CDRec(ts_m)
    imputer.impute()


    # compute and print the imputation metrics
    imputer.score(ts.data, imputer.recov_data)
    ts.print_results(imputer.metrics)

    # plot the recovered time series
    ts.plot(input_data=ts.data, incomp_data=ts_m, recov_data=imputer.recov_data, nbr_series=6, subplot=True, save_path="./imputegap/assets")




.. _parameterization:

Parameterization
----------------

ImputeGAP provides optimization techniques that automatically identify the optimal hyperparameters for a specific algorithm in relation to a given dataset.
The available optimizers are: Greedy Optimizer (GO), Bayesian Optimizer (BO), Particle Swarm Optimizer (PSO), and Successive Halving (SH).

**Example Auto-ML**

.. code-block:: python

    from imputegap.recovery.imputation import Imputation
    from imputegap.recovery.manager import TimeSeries
    from imputegap.tools import utils

    # 1. initiate the TimeSeries() object that will stay with you throughout the analysis
    ts_1 = TimeSeries()

    # 2. load the timeseries from file or from the code
    ts_1.load_series(utils.search_path("eeg-alcohol"))
    ts_1.normalize(normalizer="min_max")

    # 3. contamination of the data
    ts_mask = ts_1.Contamination.mcar(ts_1.data)

    # 4. imputation of the contaminated data
    # imputation with AutoML which will discover the optimal hyperparameters for your dataset and your algorithm
    imputer = Imputation.MatrixCompletion.CDRec(ts_mask).impute(user_def=False, params={"input_data": ts_1.data, "optimizer": "ray_tune"})

    # 5. score the imputation with the raw_data
    imputer.score(ts_1.data, imputer.recov_data)

    # 6. display the results
    ts_1.print_results(imputer.metrics)
    ts_1.plot(input_data=ts_1.data, incomp_data=ts_mask, recov_data=imputer.recov_data, max_series=9, subplot=True, save_path="./imputegap/assets", display=True)

    # 7. save hyperparameters
    utils.save_optimization(optimal_params=imputer.parameters, algorithm=imputer.algorithm, dataset="eeg", optimizer="ray_tune")




.. _explainer:

Explainer
---------


ImputeGAP allows users to explore the features in the data that impact the imputation results
through Shapely Additive exPlanations ([**SHAP**](https://shap.readthedocs.io/en/latest/)). To attribute a meaningful interpretation of the SHAP results, ImputeGAP groups the extracted features into four categories:
geometry, transformation, correlation, and trend.


**Example Explainer**

.. code-block:: python

    from imputegap.recovery.manager import TimeSeries
    from imputegap.recovery.explainer import Explainer
    from imputegap.tools import utils

    # 1. initiate the TimeSeries() object that will stay with you throughout the analysis
    ts_1 = TimeSeries()

    # 2. load the timeseries from file or from the code
    ts_1.load_series(utils.search_path("eeg-alcohol"))

    # 3. call the explanation of your dataset with a specific algorithm to gain insight on the Imputation results
    shap_values, shap_details = Explainer.shap_explainer(input_data=ts_1.data, extractor="pycatch", pattern="mcar",
                                                         missing_rate=0.25, limit_ratio=1, split_ratio=0.7,
                                                         file_name="eeg-alcohol", algorithm="cdrec")

    # [OPTIONAL] print the results with the impact of each feature.
    Explainer.print(shap_values, shap_details)




